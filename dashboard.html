<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analyst Dashboard | Cannabis Payment Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">
  <div class="container-fluid py-4">
    <div class="row">
      <div class="col-12">
        <h1 class="text-success mb-4">Analyst Dashboard</h1>
        <p class="text-muted">Manage report requests from the quiz.</p>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4" id="statsRow" style="display: none;">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body text-center">
            <h5 id="totalRequests">0</h5>
            <p>Total Requests</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-white">
          <div class="card-body text-center">
            <h5 id="pendingCount">0</h5>
            <p>Pending</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body text-center">
            <h5 id="sentCount">0</h5>
            <p>Sent</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-secondary text-white">
          <div class="card-body text-center">
            <h5 id="reviewedCount">0</h5>
            <p>Reviewed</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Requests Table -->
    <div class="card shadow">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Report Requests</h5>
        <button class="btn btn-success btn-sm" onclick="refreshData()">Refresh</button>
      </div>
      <div class="card-body">
        <div id="tableContainer">
          <p class="text-center text-muted">Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Analyst Login</h5>
        </div>
        <div class="modal-body">
          <input type="password" class="form-control" id="passwordInput" placeholder="Enter password">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="checkPassword()">Login</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast bg-success text-white" role="alert">
      <div class="toast-header">
        <strong class="me-auto">Success</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxOIwAAViP9fY49QxUr4m8Wort3jKkQkkTJhAnt3OcFGU08CjkJT-wghzGXq4aqvUjhDA/exec'; // Replace with your GAS URL
    const DASHBOARD_PASSWORD = 'analyst123'; // Change this! Hardcoded for simplicity
    
    // Show password modal on load
    window.onload = () => {
      new bootstrap.Modal(document.getElementById('passwordModal')).show();
    };
    
    function checkPassword() {
      const input = document.getElementById('passwordInput').value;
      if (input === DASHBOARD_PASSWORD) {
        document.getElementById('passwordModal').querySelector('.btn-success').disabled = true;
        bootstrap.Modal.getOrCreateInstance(document.getElementById('passwordModal')).hide();
        loadData();
      } else {
        alert('Incorrect password.');
      }
    }
    
    async function loadData() {
      try {
        const response = await fetch(GAS_WEB_APP_URL);
        const { rows } = await response.json();
        
        // Update stats
        const total = rows.length;
        const pending = rows.filter(r => r.status === 'Pending').length;
        const sent = rows.filter(r => r.status === 'Sent').length;
        const reviewed = rows.filter(r => r.status === 'Reviewed').length;
        
        document.getElementById('totalRequests').textContent = total;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('sentCount').textContent = sent;
        document.getElementById('reviewedCount').textContent = reviewed;
        document.getElementById('statsRow').style.display = 'flex';
        
        // Build table
        let tableHtml = `
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Timestamp</th><th>Business</th><th>Contact</th><th>Type/Segment</th><th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        rows.forEach(row => {
          tableHtml += `
            <tr>
              <td>${row.timestamp}</td>
              <td>${row.businessName}</td>
              <td>$$ {row.fullName}<br> $${row.businessEmail}<br>${row.cellPhone}</td>
              <td>$$ {row.businessType}<br> $${row.segmentKey}</td>
              <td>
                <span class="badge $$ {getStatusBadgeClass(row.status)}"> $${row.status}</span>
              </td>
              <td>
                ${row.pdfLink ? `<a href="${row.pdfLink}" target="_blank" class="btn btn-sm btn-outline-primary">View PDF</a>` : 'No PDF'}
                <button class="btn btn-sm btn-success ms-1" onclick="sendPDF(${row.id})" ${row.status === 'Sent' ? 'disabled' : ''}>Send to Client</button>
                <button class="btn btn-sm btn-secondary ms-1" onclick="updateStatus(${row.id}, 'Reviewed')">Mark Reviewed</button>
              </td>
            </tr>
          `;
        });
        
        tableHtml += '</tbody></table>';
        document.getElementById('tableContainer').innerHTML = tableHtml;
      } catch (error) {
        document.getElementById('tableContainer').innerHTML = `<p class="text-danger">Error loading data: ${error.message}</p>`;
      }
    }
    
    function getStatusBadgeClass(status) {
      switch (status) {
        case 'Pending': return 'bg-warning';
        case 'Sent': return 'bg-success';
        case 'Reviewed': return 'bg-info';
        default: return 'bg-secondary';
      }
    }
    
    async function sendPDF(rowId) {
      if (confirm('Send PDF to client?')) {
        try {
          const response = await fetch(GAS_WEB_APP_URL, {
            method: 'POST',
            body: new URLSearchParams({ action: 'sendPDF', rowId: rowId })
          });
          const result = await response.text();
          if (result === 'SUCCESS: PDF Sent') {
            showToast('PDF sent successfully!');
            refreshData(); // Reload table
          } else {
            alert('Error: ' + result);
          }
        } catch (error) {
          alert('Network error: ' + error.message);
        }
      }
    }
    
    async function updateStatus(rowId, status) {
      // Similar POST to update status (add to GAS if needed)
      alert(`Marked as ${status} (implement update in GAS for full func.)`);
      refreshData();
    }
    
    function refreshData() {
      loadData();
    }
    
    function showToast(message) {
      const toast = new bootstrap.Toast(document.getElementById('successToast'));
      document.querySelector('#successToast .toast-body').textContent = message;
      toast.show();
    }
  </script>
</body>
</html>
